<html>
  <head>
    <script defer src="draw.js"></script>
    <link rel="stylesheet" href="ui.css" />
  </head>

  <body>
    <b>PALETTE</b>
    <div id="palette"></div>
    <hr />

    <button id="finishTileButton">Finish Tile</button>
    <button id="downloadButton">Download Image</button>
    <hr />

    <canvas id="pixelCanvas"></canvas>

    <script>
      const canvas = document.getElementById("pixelCanvas");
      const ctx = canvas.getContext("2d");
      const gridSize = 3;
      const tileSize = 16;
      const pixelSize = 10; // Scaling up pixels for better visibility
      const currentTile = { x: 0, y: 0 }; // Tracks which tile is active
      const finishedTiles = new Set(); // Tracks finished tiles
      
      const downloadButton = document.getElementById("downloadButton");
      let isDrawing = false;
      let selectedColor = "#000000"; // Default black color
      let cursorX = -1,
        cursorY = -1;

      // Define a 32-color palette
      const palette = [
        "#000000",
        "#FFFFFF",
        "#FF0000",
        "#00FF00",
        "#0000FF",
        "#FFFF00",
        "#FF00FF",
        "#00FFFF",
        "#800000",
        "#808000",
        "#008000",
        "#800080",
        "#808080",
        "#C0C0C0",
        "#008080",
        "#000080",
        "#FFA500",
        "#A52A2A",
        "#DC143C",
        "#FF4500",
        "#2E8B57",
        "#32CD32",
        "#ADFF2F",
        "#FFD700",
        "#DAA520",
        "#B8860B",
        "#8B4513",
        "#FA8072",
        "#E9967A",
        "#4682B4",
        "#5F9EA0",
        "#7FFFD4",
      ];

      canvas.width = gridSize * tileSize * pixelSize;
      canvas.height = gridSize * tileSize * pixelSize;

      const grid = Array(gridSize * tileSize)
        .fill()
        .map(() => Array(gridSize * tileSize).fill("#FFFFFF"));

      const paletteContainer = document.getElementById("palette");
      palette.forEach((color) => {
        const colorButton = document.createElement("div");
        colorButton.style.background = color;
        colorButton.classList.add("color-swatch");
        colorButton.addEventListener("click", () => (selectedColor = color));
        paletteContainer.appendChild(colorButton);
      });

      function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let y = 0; y < gridSize * tileSize; y++) {
          for (let x = 0; x < gridSize * tileSize; x++) {
            const tileX = Math.floor(x / tileSize);
            const tileY = Math.floor(y / tileSize);
            const tileKey = `${tileX},${tileY}`;
            const inCurrentTile =
              tileX === currentTile.x && tileY === currentTile.y;
            const isBorder =
              x % tileSize === 0 ||
              x % tileSize === 15 ||
              y % tileSize === 0 ||
              y % tileSize === 15;
            const isFinished = finishedTiles.has(tileKey);

            ctx.fillStyle = isFinished
              ? "#DDDDDD"
              : inCurrentTile || isBorder
              ? grid[y][x]
              : "#AAAAAA";
            ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);

            ctx.strokeStyle = "#CCCCCC";
            ctx.lineWidth = 0.5;
            ctx.strokeRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
          }
        }

        ctx.strokeStyle = "#000000";
        ctx.lineWidth = 4;
        for (let i = 1; i < gridSize; i++) {
          let pos = i * tileSize * pixelSize;
          ctx.beginPath();
          ctx.moveTo(pos, 0);
          ctx.lineTo(pos, canvas.height);
          ctx.moveTo(0, pos);
          ctx.lineTo(canvas.width, pos);
          ctx.stroke();
        }

        if (cursorX >= 0 && cursorY >= 0) {
          ctx.strokeStyle = selectedColor;
          ctx.lineWidth = 2;
          ctx.strokeRect(
            cursorX * pixelSize,
            cursorY * pixelSize,
            pixelSize,
            pixelSize
          );
        }

        
      }

      drawGrid();

      canvas.addEventListener("mousedown", (event) => {
        isDrawing = true;
        drawPixel(event);
      });
      canvas.addEventListener("mouseup", () => (isDrawing = false));
      canvas.addEventListener("mousemove", (event) => {
        updateCursor(event);
        if (isDrawing) drawPixel(event);
      });
      canvas.addEventListener("contextmenu", (event) => {
        event.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((event.clientX - rect.left) / pixelSize);
        const y = Math.floor((event.clientY - rect.top) / pixelSize);
        selectedColor = grid[y][x];
      });

      function drawPixel(event) {
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((event.clientX - rect.left) / pixelSize);
        const y = Math.floor((event.clientY - rect.top) / pixelSize);

        const tileX = Math.floor(x / tileSize);
        const tileY = Math.floor(y / tileSize);
        const tileKey = `${tileX},${tileY}`;
        if (!finishedTiles.has(tileKey)) {
          grid[y][x] = selectedColor;
          drawGrid();
        }
      }

      function updateCursor(event) {
        const rect = canvas.getBoundingClientRect();
        cursorX = Math.floor((event.clientX - rect.left) / pixelSize);
        cursorY = Math.floor((event.clientY - rect.top) / pixelSize);
        drawGrid();
      }

      canvas.addEventListener("click", (event) => {
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor(
          (event.clientX - rect.left) / (tileSize * pixelSize)
        );
        const y = Math.floor(
          (event.clientY - rect.top) / (tileSize * pixelSize)
        );
        currentTile.x = x;
        currentTile.y = y;
        drawGrid();
      });

      function finishTile() {
        const tileKey = `${currentTile.x},${currentTile.y}`;
        finishedTiles.add(tileKey);
        drawGrid();
      }

      document
        .getElementById("finishTileButton")
        .addEventListener("click", finishTile);

      downloadButton.addEventListener("click", () => {
        const link = document.createElement("a");
        link.download = "pixel_exquisite_corpse.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    </script>
  </body>
</html>
